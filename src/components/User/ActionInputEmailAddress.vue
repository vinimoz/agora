<!--
  - SPDX-FileCopyrightText: 2018 Nextcloud contributors
  - SPDX-License-Identifier: AGPL-3.0-or-later
-->

<script setup lang="ts">
import { ref } from 'vue';
import { debounce } from 'lodash';
import { showSuccess, showError } from '@nextcloud/dialogs';
import { t } from '@nextcloud/l10n';

import NcActionInput from '@nextcloud/vue/components/NcActionInput';
import EditEmailIcon from 'vue-material-design-icons/EmailEditOutline.vue';

import { ValidatorAPI } from '../../Api/index.ts';
import { StatusResults } from '../../Types/index.ts';
import { useSessionStore } from '../../stores/session.ts';

type InputProps = {
  success: boolean;
  error: boolean;
  showTrailingButton: boolean;
  labelOutside: boolean;
  label: string;
};

const sessionStore = useSessionStore();

const inputProps = ref<InputProps>({
  success: false,
  error: false,
  showTrailingButton: true,
  labelOutside: false,
  label: t('agora', 'Edit Email Address')
});

/**
 *
 * @param status
 */
function setStatus(status: StatusResults) {
  inputProps.value.success = status === 'success';
  inputProps.value.error = status === 'error';
  inputProps.value.showTrailingButton = status === 'success';
}

const validate = debounce(async function () {
  if (
    sessionStore.share.user.emailAddress ===
    sessionStore.currentUser.emailAddress
  ) {
    setStatus('unchanged');
    return;
  }

  try {
    await ValidatorAPI.validateEmailAddress(
      sessionStore.share.user.emailAddress
    );
    setStatus('success');
  } catch {
    setStatus('error');
  }
}, 500);

/**
 *
 */
async function submit() {
  try {
    await sessionStore.updateEmailAddress({
      emailAddress: sessionStore.share.user.emailAddress
    });
    showSuccess(
      t('agora', 'Email address {emailAddress} saved.', {
        emailAddress: sessionStore.share.user.emailAddress
      })
    );
    setStatus('unchanged');
  } catch {
    showError(
      t('agora', 'Error saving email address {emailAddress}', {
        emailAddress: sessionStore.share.user.emailAddress
      })
    );
    setStatus('error');
  }
}
</script>

<template>
  <NcActionInput
    v-if="sessionStore.route.name === 'publicInquiry'"
    v-bind="inputProps"
    v-model="sessionStore.share.user.emailAddress"
    @update:model-value="validate"
    @submit="submit"
  >
    <template #icon>
      <EditEmailIcon />
    </template>
    {{ inputProps.label }}
  </NcActionInput>
</template>
